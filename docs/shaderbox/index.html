<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Rapid Prototyping of Graphics Shaders in Modern C++</title><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"><link href="node_modules/reveal.js/css/reveal.css" rel="stylesheet"><link rel="stylesheet" href="node_modules/reveal.js/css/theme/black.css" id="theme"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css"><link href="node_modules/reveal.js/lib/css/zenburn.css" rel="stylesheet"><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "node_modules/reveal.js/css/print/pdf.css" : "node_modules/reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><!--[if lt IE 9]><script src="node_modules/reveal.js/lib/js/html5shiv.js"></script><![endif]--><link rel="stylesheet" href="main.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title" data-background-image="img/title.png"><h1>Rapid Prototyping of Graphics Shaders in Modern C++</h1></section><section id="valentin_galea" data-background-image="img/sd-brand/banner.jpg"><h2>Valentin Galea</h2><div class="paragraph"><p><a href="https://twitter.com/valentin_galea">@valentin_galea</a></p></div>
<div class="paragraph"><p>More than 10 years in
<em>mobile</em>, <em>indie</em> and <em>AAA</em> games</p></div>
<div class="imageblock" style=""><img src="img/sd-brand/SD-logo-white.svg" alt="SD" width="128" height="128"></div></section>
<section id="agenda"><h2>Agenda</h2><div class="ulist"><ul><li><p>Intro and Motivation</p></li><li><p>Shading Languages</p></li><li><p>C++</p></li><li><p>Showcase</p></li></ul></div>
<div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">questions welcomed throughout</td></tr></table></div></section>
<section id="shaders"><h2>Shaders</h2><div class="quoteblock"><blockquote>A computer program that is used to do <strong>shading</strong></blockquote></div></section>
<section id="shaders_definition" data-background-image="img/intro/shaded_shapes.jpg"><div class="quoteblock"><blockquote>Depicting depth perception in 3D models or illustrations by varying levels of darkness</blockquote><div class="attribution">&#8212; Wikipedia</div></div></section>
<section id="shaders_pixar" data-background-image="img/intro/pixar_luxo.jpg"><div class="quoteblock"><blockquote>A computer program that tells the computer how to draw something</blockquote><div class="attribution">&#8212; Pixar RenderMan 1988</div></div></section>
<section id="shaders_on_modern_gpu_s" data-state="GPU"><h2>Shaders on Modern GPU&#8217;s</h2><div class="imageblock" style="float: right"><img src="img/intro/gpu_gtx1080.png" alt="GPU" width="60%"></div>
<div class="paragraph"><p><code>-</code> Computer graphics</p></div>
<div class="paragraph"><p><code>-</code> Image manipulation</p></div>
<div class="paragraph"><p><code>-</code> Highly parallel computing</p></div></section>
<section id="why_on_gpu"><h2>Why on GPU</h2><div class="imageblock" style=""><img src="img/intro/cpu_vs_gpu.png" alt="cpu vs gpu"></div></section>
<section id="types_of_shaders"><h2>Types of Shaders</h2><div class="imageblock" style="float: right"><img src="img/intro/pipeline.png" alt="pipeline"></div>
<div class="paragraph"><p>Vertex<br>
Geometry<br>
Tessellation<br>
Fragment(Pixel)<br>
<code>-----</code><br>
Compute</p></div></section>
<section id="pixel_fragment_shader"><h2>Pixel/Fragment Shader</h2><div class="imageblock" style=""><img src="img/intro/materials.jpg" alt="mat" width="80%"></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa fa-exclamation-circle" title="Important"></i></td><td class="content">We will concentrate on (procedurally generated) image-only shaders</td></tr></table></div></section>
<section id="motivation"><h2>Motivation</h2><div class="paragraph"><p>I wanted to create real-time effects like&#8230;&#8203;</p></div></section>
<section id="example_1" data-background-image="img/motivation/snail.jpg"></section>
<section id="example_2" data-background-image="img/motivation/rainforest.png"></section>
<section id="example_3" data-background-image="img/motivation/temple.png"></section>
<section data-state="GPU"><div class="paragraph"><p>on more limited devices&#8230;&#8203;</p></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p><span class="image"><img src="img/motivation/galaxy-s7-edge.png" alt="s7"></span></p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p><span class="image"><img src="img/motivation/tablet-pc.png" alt="tablet-pc"></span></p></div></div></td></tr></table></section>
<section data-background-image="img/motivation/commute.png" data-state="commute">
<div class="paragraph"><p>&#8230;&#8203;because of long commutes!</p></div></section>
<section data-background-image="img/motivation/snail-bug.png" data-state="gpu_bug">
<div class="paragraph"><p>also because GPU driver render bugs</p></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">taken on desktop PC / Nvidia GTX 1060</td></tr></table></div></section>
<section id="other_advantages"><h2>Other advantages</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p>Debug / Decompile algorithms from</p><div class="ulist"><ul><li><p><a href="http://www.shadertoy.com">shadertoy.com</a></p></li><li><p><a href="http://www.glslsandbox.com">glslsandbox.com</a></p></li></ul></div></li><li><p>Unit Test shaders!</p></li><li><p>Quick prototype</p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p><span class="image"><img src="img/motivation/shadertoy.png" alt="shadertoy"></span></p></div></div></td></tr></table></section>
<section id="shading_languages"><h2>Shading Languages</h2></section>
<section id="pixar_renderman_language" data-background-image="img/intro/renderman.jpg" data-state="RSL"><h2>Pixar RenderMan Language</h2>
<div class="listingblock strech"><div class="content"><pre class="highlight"><code data-noescape class="javascript language-javascript">/*
 * red mesh                   red shaded mesh
 */
surface basic() {             surface simple(color myOpacity = 1) {
    Ci = (1.0, 0.0, 0.0);         color myColor = (1.0, 0.0, 0.0);
    Oi = 1;                       normal Nn = normalize(N);
}                                 Ci = myColor * myOpacity * diff;
                                  Oi = myOpacity;
                              }</code></pre></div></div></section>
<section id="shading_languages_history"><h2>Shading Languages History</h2><div class="paragraph"><p>For real-time rendering:</p></div>
<div class="ulist"><ul><li><p>Early: ARB assembly, Cg</p></li><li><p>OpenGL shading language (<strong>GLSL</strong>)</p></li><li><p>DirectX High-Level Shader Language (<strong>HLSL</strong>)</p></li><li><p>PlayStation Shader Language (similar to HLSL)</p></li></ul></div></section>
<section id="glsl_and_hlsl"><h2>GLSL and HLSL</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="javascript language-javascript">varying vec3 N;
varying vec3 v;
void main(void)
{
   vec3 L = normalize(gl_LightSource[0].position.xyz - v);
   vec4 Idiff = gl_FrontLightProduct[0].diffuse * max(dot(N,L), 0);
   Idiff = clamp(Idiff, 0.0, 1.0);
   gl_FragColor = Idiff;
}</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="javascript language-javascript">float4 main(
    float3 Light: TEXCOORD0,
    float3 Norm : TEXCOORD1) : COLOR
{
    float4 diffuse = { 1.0, 0.0, 0.0, 1.0 };
    float4 ambient = { 0.1, 0.0, 0.0, 1.0 };
    return ambient + diffuse * saturate(dot(Light, Norm));
}</code></pre></div></div></section>
<section id="glsl_vs_hlsl_general"><h2>GLSL vs HLSL: general</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Procedural, step-centric (C like)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Object oriented, data-centric (C++ like)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Compilation done in driver</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Client side compilation</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code>, <code>int</code>, <code>bool</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code>, <code>int</code>, <code>bool</code>, <code>uint</code>, <code>double</code></p></td></tr></table></section>
<section id="glsl_vs_hlsl_types"><h2>GLSL vs HLSL: types</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Vector type: <code>vec2</code>, <code>vec3</code>, <code>vec4</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Vector type: <code>float2</code>, <code>float3</code>, <code>float4</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Matrix type: <code>mat2</code>, <code>mat3</code>, <code>mat4</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Matrix type: <code>float2x2</code>, <code>float3x3</code>, <code>float4x4</code></p></td></tr><tr><td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">&#8230;&#8203;textures, samplers, precision modifiers etc</p></td></tr></table></section>
<section id="shading_languages_future"><h2>Shading Languages Future</h2><div class="paragraph"><p>Basically C++ (usually via LLVM)</p></div>
<div class="ulist step"><ul><li class="fragment"><p>Metal Shading Language (C++14, Apple)</p><div class="ulist"><ul><li><p>only on iOS devices</p></li></ul></div></li><li class="fragment"><p>CUDA Heterogeneous Computing (C++11, NVidia)</p><div class="ulist"><ul><li><p>only for computing, not graphics</p></li></ul></div></li><li class="fragment"><p>HLSL 6.x (C++98&#8217;ish, Microsoft)</p><div class="ulist"><ul><li><p>not released yet</p></li></ul></div></li></ul></div></section>
<section><div class="paragraph"><p>Let&#8217;s see how C++ can help out, NOW!</p></div></section>
<section id="the_plan" data-state="plan"><h2>The Plan</h2><div class="ulist"><ul><li class="fragment"><p><span class="image"><img src="img/icon/browser.svg" alt="cpp" width="64" height="64"></span> Pick a shading language and twist C++ to accept it as source code!</p></li><li class="fragment"><p><span class="image"><img src="img/icon/management.svg" alt="bonus" width="64" height="64"></span> BONUS: use the preprocessor for transcription back to the original language(s)!</p></li></ul></div></section>
<section id="the_plan_cont"><h2>The Plan (cont.)</h2><div class="ulist"><ul><li class="fragment"><p>obligatory preprocessor layer</p></li><li class="fragment"><p>vector (linear algebra) types</p><div class="ulist"><ul><li><p>swizzle support</p></li></ul></div></li><li class="fragment"><p>matrix types</p></li><li class="fragment"><p>operators</p></li><li class="fragment"><p>"standard library" utility/math functions</p></li></ul></div></section>
<section id="place_your_bets"><h2>Place Your Bets</h2><div class="paragraph"><p>We will chose <strong>GLSL</strong> as it&#8217;s used on <em>desktop</em>, <em>web</em> and <em>mobile</em></p></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">only a subset of it - concentrate on procedural graphics thus minimize/eliminate inputs (textures, vertex data, etc)</td></tr></table></div></section>
<section id="languages_declarations"><h2>Languages: Declarations</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">GLSL</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">HLSL</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">C++</p></td></tr><tr><td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
C-style types and arrays</p></td></tr><tr><td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
C-style <code>struct</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>T name = T ( &#8230;&#8203; )</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>T name = { &#8230;&#8203; }</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">both (preproc abstraction)</p></td></tr></table></section>
<section id="languages_arguments"><h2>Languages: Arguments</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">GLSL/HLSL</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">C++</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Macro glue</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>const in T</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>const T &amp;</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>_in(T)</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>inout T</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>T &amp;</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>_inout(T)</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>out T</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>T &amp;</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>_out(T)</code></p></td></tr></table></section>
<section id="vectors_and_matrices"><h2>Vectors and Matrices</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">// vectors are generic
vec2 texcoord1, texcoord2;
vec3 position;
vec4 myRGBA;
ivec2 textureLookup;
bvec3 less;

// matrices are floating point only
mat2 mat2D;
mat3 optMatrix;
mat4 view, projection;</code></pre></div></div></section>
<section id="vector_swizzle"><h2>Vector Swizzle</h2><div class="paragraph"><p>Syntactic sugar for easy referring to components (or combination of)</p></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">{ x, y, z, w }</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">to represent points or normals</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">{ r, g, b, a }</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">to refer to colors (<code>a</code> is alpha/translucency)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">{ s, t, p, q }</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">texture coordinates</p></td></tr></table></section>
<section id="vector_swizzle_examples"><h2>Vector Swizzle - Examples</h2><div class="listingblock"><div class="title">subcomponents mix &amp; match</div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">vec4 v4;
v4.rgba;  // is a vec4 and the same as just using v4,
v4.rgb;   // is a vec3,
v4.b;     // is a float,
v4.xy;    // is a vec2,</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">vec4 pos = vec4(1.0, 2.0, 3.0, 4.0);
vec4 swiz= pos.wzyx; // swiz = (4.0, 3.0, 2.0, 1.0)
vec4 dup = vec4(pos.xx, pos.yy);</code></pre></div></div>
<div class="listingblock"><div class="title">l-value assigment</div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">pos.xw = vec2(5.0, 6.0); // pos = (5.0, 2.0, 3.0, 6.0)
pos.xx = vec2(3.0, 4.0); // illegal - 'x' used twice</code></pre></div></div></section>
<section id="vector_swizzle_motivation"><h2>Vector Swizzle - Motivation</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">vec3 calcNormal( in vec3 pos )
{
    vec2 e = vec2(1.0, -1.0) * 0.0005;

    return normalize(
        e.xyy * map( pos + e.xyy ).x +
        e.yyx * map( pos + e.yyx ).x +
        e.yxy * map( pos + e.yxy ).x +
        e.xxx * map( pos + e.xxx ).x );
}</code></pre></div></div></section>
<section id="operators"><h2>Operators</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>syntax</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>equivalent</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">w = v + u;</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">w.x = v.x + u.x;
w.y = v.y + u.y;
w.z = v.z + u.z;</code></pre></div></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">u = v * m;</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">u.x = dot(v, m[0]);
u.y = dot(v, m[1]);
u.z = dot(v, m[2]);
/* dot(a,b) is the inner product of a and b */</code></pre></div></div></div></td></tr></table></section>
<section id="standard_library" data-state="STL"><h2>"Standard Library"</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Math</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>sin</code>, <code>cos</code>, <code>radians</code>, <code>pow</code>, <code>exp</code>, etc</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Common</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>abs</code>, <code>sign</code>, <code>floor</code>, <code>mod</code>, <code>min</code>, etc</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Utility</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>mix</code>, <code>step</code>, <code>smoothstep</code>, etc</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Geometry</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>length</code>, <code>dot</code>, <code>cross</code>, <code>distance</code>, etc</p></td></tr><tr><td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Specific texture and image sampling &#8230;&#8203;</p></td></tr></table></section>
<section><div class="paragraph"><p>Recreating all this in C++ &#8230;&#8203;</p></div></section>
<section id="design_of_code_vector_code" data-state="no_list_decor"><h2>Design of <code>vector&lt;&gt;</code></h2><div class="ulist"><ul><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T, size_t N&gt;
struct vector :
    public vector_base&lt;T, N&gt;
{</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    vector();
    explicit vector(scalar_type s);
    template&lt;typename... Args&gt; explicit vector(Args... args);</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    scalar_type&amp; operator[](size_t i);
    scalar_type&amp; operator[](size_t i);

    vector_type&amp; operator +=(scalar_type s);
    vector_type&amp; operator +=(const vector_type&amp; v);
(etc)</code></pre></div></div></li></ul></div></section>
<section id="code_vector_code_ctor_basic"><h2><code>vector&lt;&gt;</code> ctor - basic</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">vector()
{
    static_for&lt;0, N&gt;()([this](size_t i) {
        data[i] = 0;
    });
}

explicit vector(scalar_type s)
{
    static_for&lt;0, N&gt;()([s, this](size_t i) {
        data[i] = s;
    });
}</code></pre></div></div></section>
<section id="code_static_for_code_utility" data-state="no_list_decor"><h2><code>static_for</code> utility</h2><div class="ulist"><ul><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;size_t Begin, size_t End&gt;
struct static_for
{
    template&lt;class Func&gt;
    constexpr void operator ()(Func&amp;&amp; f)
    {
        f(Begin);
        static_for&lt;Begin + 1, End&gt;()(std::forward&lt;Func&gt;(f));
    }
};</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;size_t N&gt;
struct static_for&lt;N, N&gt;
{
    template&lt;class Func&gt;
    constexpr void operator ()(Func&amp;&amp;) { /* empty */ }
};</code></pre></div></div></li></ul></div></section>
<section id="code_vector_code_ctor_advanced"><h2><code>vector&lt;&gt;</code> ctor - advanced</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename A0, typename... Args,</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    class = typename std::enable_if&lt;
        ((sizeof... (Args) &gt;= 1) ||
        ((sizeof... (Args) == 0) &amp;&amp; !std::is_scalar_v&lt;A0&gt;))
    &gt;::type&gt;</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">explicit vector(A0&amp;&amp; a0, Args&amp;&amp;... args)
{
    iterate_construct&lt;0, num_components&gt;(
        std::forward&lt;A0&gt;(a0), std::forward&lt;Args&gt;(args)...
    );
}</code></pre></div></div></section>
<section id="code_vector_code_ctor_advanced_2"><h2><code>vector&lt;&gt;</code> ctor - advanced (2)</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;size_t I, size_t IMax, typename Arg0, typename... Args&gt;
void iterate_construct(Arg0&amp;&amp; a0, Args&amp;&amp;... args)
{
    if constexpr (I &lt; IMax) {
        construct_at_index(I, std::forward&lt;Arg0&gt;(a0));
        iterate_construct&lt;I + get_size&lt;Arg0&gt;(), IMax&gt;(
            std::forward&lt;Args&gt;(args)...);
    }
}</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;size_t I, size_t IMax&gt;
void iterate_construct()
{
}</code></pre></div></div></section>
<section id="code_vector_code_ctor_advanced_3"><h2><code>vector&lt;&gt;</code> ctor - advanced (3)</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">void construct_at_index(size_t&amp; i, scalar_type arg)
{
    data[i++] = arg;
}</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename Other, size_t Other_N&gt;
void construct_at_index(size_t&amp; i, vector&lt;Other, Other_N&gt;&amp;&amp; arg)
{
    constexpr auto count = std::min(N, Other_N);

    detail::static_for&lt;0, count&gt;()([&amp;](size_t j) {
        data[i++] = arg.data[j];
    });
}</code></pre></div></div></section>
<section id="code_vector_code_ctor_in_action"><h2><code>vector&lt;&gt;</code> ctor in action</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">using vec2 = vector&lt;int, 2&gt;;
using vec3 = vector&lt;int, 3&gt;;

vec3 v = vec3(98, vec2(99, 100));
//             ^    ^
//             |    |
//             `-- scalar construct gets called
//                  |
//                  `---- sub-vector construct gets called
//                        and then recursively again</code></pre></div></div></section>
<section id="godbolt"><h2>Godbolt</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">int main()
{
    float a, b;
    scanf("%f %f", &amp;a, &amp;b);

    auto v = vec3(1.f, vec2(a, b));

    printf("%f %f", v.x, v.y);
}</code></pre></div></div>
<div class="paragraph"><p><code>-std=c++17 -Wall -O2</code> <a href="https://tinyurl.com/godbolt">(source)</a></p></div></section>
<section id="godbolt_cont" data-state="godbolt"><h2>Godbolt (cont.)</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">clang (5.x/6.x)</th><th class="tableblock halign-left valign-top">gcc (7.x/8.x)</th><th class="tableblock halign-left valign-top">msvc (2017)</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">call    scanf
movss   xmm0, dword ptr [rsp + 4]
cvtss2sd        xmm1, xmm0
movss   xmm0, dword ptr [rsp]
cvtss2sd        xmm2, xmm0
movsd   xmm0, qword ptr [rip + .LCPI0_0]
mov     edi, offset .L.str.1
mov     al, 3
call    printf</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">call    scanf
pxor    xmm2, xmm2
pxor    xmm1, xmm1
movsd   xmm0, QWORD PTR .LC1[rip]
mov     edi, OFFSET FLAT:.LC2
mov     eax, 3
cvtss2sd        xmm2, DWORD PTR [rsp+12]
cvtss2sd        xmm1, DWORD PTR [rsp+8]
call    printf</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">call    scanf
movss   xmm1, DWORD PTR b$[rsp]
lea     rcx, OFFSET FLAT:`string'
movss   xmm0, DWORD PTR a$[rsp]
movss   DWORD PTR $T1[rsp+4], xmm1
movsd   xmm1, QWORD PTR __real@3ff0000000
movss   DWORD PTR $T1[rsp], xmm0
movq    rdx, xmm1
mov     rax, QWORD PTR $T1[rsp]
mov     QWORD PTR &lt;args_1&gt;$[rsp], rax
movss   xmm3, DWORD PTR &lt;args_1&gt;$[rsp+4]
movss   xmm2, DWORD PTR &lt;args_1&gt;$[rsp]
cvtps2pd xmm3, xmm3
cvtps2pd xmm2, xmm2
movq    r9, xmm3
movq    r8, xmm2
call    printf</code></pre></div></div></div></td></tr></table></section>
<section id="problem_debug"><h2>Problem: Debug</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">void detail::static_for&lt;0ul, 3ul&gt;::operator()&lt;vector&lt;float, 3ul&gt;...
    push    rbp
    mov     rbp, rsp
    sub     rsp, 32
    mov     QWORD PTR [rbp-24], rdi
    mov     QWORD PTR [rbp-32], rsi
    mov     rax, QWORD PTR [rbp-32]
    mov     esi, 0
    mov     rdi, rax
    call    vector&lt;float, 3ul&gt;::vector(float)::{lambda(unsigned...
    mov     rax, QWORD PTR [rbp-32]
    mov     rdi, rax
    call    vector&lt;float, 3ul&gt;::vector(float)::{lambda(unsigned...
    mov     rdx, rax
    lea     rax, [rbp-1]
    mov     rsi, rdx
    mov     rdi, rax
    call    void detail::static_for&lt;1ul, 3ul&gt;::operator()&lt;vector...
    nop
    leave
    ret</code></pre></div></div></section>
<section id="improved_design_of_code_vector_code" data-state="no_list_decor"><h2>Improved design of <code>vector&lt;&gt;</code></h2><div class="ulist"><ul><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T, size_t... Ns&gt;
struct vector :
    public vector_base&lt;T, Ns...&gt;
{</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    vector()
    {
        ((data[Ns] = 0), ...);
    }</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    explicit vector(scalar_type s)
    {
        ((data[Ns] = s), ...);
    }

    template&lt;typename A0, typename... Args&gt; explicit vector
(etc)</code></pre></div></div></li></ul></div></section>
<section id="folding_expressions"><h2>Folding Expressions</h2><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content"><code>C++17</code> unary fold expression over comma operator</td></tr></table></div>
<div class="ulist"><div class="title">Compatibility</div><ul><li><p>gcc 6+</p></li><li><p>clang 3.6+</p></li><li><p>MSVC 2017 15.5+</p></li></ul></div></section>
<section id="improved_code_vector_code_ctor"><h2>Improved <code>vector&lt;&gt;</code> ctor</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename A0, typename... Args&gt;
explicit vector(A0&amp;&amp; a0, Args&amp;&amp;... args)
{
    size_t i = 0; // advances as we consume args

    // consume the first one
    construct_at_index(i, std::forward&lt;A0&gt;(a0));

    // consume the rest, if any
    (construct_at_index(i, std::forward&lt;Args&gt;(args)), ...);
}</code></pre></div></div></section>
<section id="code_vector_base_code_naive_impl"><h2><code>vector_base</code> naive impl</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T&gt;
struct vector_base&lt;T, 2&gt;
{
    union
    {
        T data[2];
        struct { T x, y; };
        struct { T s, t; };
        struct { T u, v; };
    }
};</code></pre></div></div></section>
<section id="code_vector_base_code_naive_impl_2"><h2><code>vector_base</code> naive impl (2)</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T&gt;
struct vector_base&lt;T, 3&gt;
{
    union
    {
        T data[3];
        struct { T x, y, z; };
        struct { T r, g, b; };
        struct { T s, t, p; };
    }
};</code></pre></div></div></section>
<section id="code_vector_base_code_naive_impl_3"><h2><code>vector_base</code> naive impl (3)</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T&gt;
struct vector_base&lt;T, 4&gt;
{
    union
    {
        T data[4];
        struct { T x, y, z, w; };
        struct { T r, g, b, a; };
        struct { T s, t, p, q; };
    }
};</code></pre></div></div></section>
<section id="code_vector_base_code_notes"><h2><code>vector_base</code> notes</h2><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">both anonymous <code>struct</code> and <code>union</code> are permitted, only MSVC complains with warning</td></tr></table></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content"><code>union</code> active member switching can be tricky <code>[10.5]</code> but we&#8217;ll use only trivial types with trivial assignment</td></tr></table></div></section>
<section id="swizzle"><h2>Swizzle</h2><div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">We introduce an additional proxy class that allows custom access to the indices and we create all possible permutations (per GLSL/HLSL standard)</td></tr></table></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;class vector_type, class T, size_t N, size_t... indices&gt;
struct swizzler
{
    T data[N]; // can differ from vector_type
...
};</code></pre></div></div></section>
<section id="swizzle_for_code_vector_t_3_code"><h2>Swizzle for <code>vector&lt;T, 3&gt;</code></h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">union
{
    T data[3];

    struct {
        swizzler&lt;0&gt;::type x;
        swizzler&lt;1&gt;::type y;
        swizzler&lt;2&gt;::type z;
    };
    struct {
        swizzler&lt;0&gt;::type r;
        swizzler&lt;1&gt;::type g;
        swizzler&lt;2&gt;::type b;
    };
    struct {
        swizzler&lt;0&gt;::type s;
        swizzler&lt;1&gt;::type t;
        swizzler&lt;2&gt;::type p;
    };
    ...</code></pre></div></div></section>
<section id="swizzle_cont"><h2>swizzle (cont.)</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    ...
    swizzler&lt;0, 0&gt;::type xx, rr, ss;
    swizzler&lt;0, 1&gt;::type xy, rg, st;
    swizzler&lt;0, 2&gt;::type xz, rb, sp;
    swizzler&lt;1, 0&gt;::type yx, gr, ts;
    swizzler&lt;1, 1&gt;::type yy, gg, tt;
    swizzler&lt;1, 2&gt;::type yz, gb, tp;
    swizzler&lt;2, 0&gt;::type zx, br, ps;
    swizzler&lt;2, 1&gt;::type zy, bg, pt;
    swizzler&lt;2, 2&gt;::type zz, bb, pp;
    ...</code></pre></div></div></section>
<section id="more_swizzle"><h2>&#8230;&#8203;more swizzle</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    ...
    swizzler&lt;0, 0, 0&gt;::type xxx, rrr, sss;
    swizzler&lt;0, 0, 1&gt;::type xxy, rrg, sst;
    swizzler&lt;0, 0, 2&gt;::type xxz, rrb, ssp;
    swizzler&lt;0, 1, 0&gt;::type xyx, rgr, sts;
    swizzler&lt;0, 1, 1&gt;::type xyy, rgg, stt;
    swizzler&lt;0, 1, 2&gt;::type xyz, rgb, stp;
    swizzler&lt;0, 2, 0&gt;::type xzx, rbr, sps;
    swizzler&lt;0, 2, 1&gt;::type xzy, rbg, spt;
    swizzler&lt;0, 2, 2&gt;::type xzz, rbb, spp;
    swizzler&lt;1, 0, 0&gt;::type yxx, grr, tss;
    swizzler&lt;1, 0, 1&gt;::type yxy, grg, tst;
    swizzler&lt;1, 0, 2&gt;::type yxz, grb, tsp;
    ...</code></pre></div></div></section>
<section id="even_more_swizzle"><h2>&#8230;&#8203;even more swizzle!</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    ...
    swizzler&lt;2, 1, 2, 0&gt;::type zyzx, bgbr, ptps;
    swizzler&lt;2, 1, 2, 1&gt;::type zyzy, bgbg, ptpt;
    swizzler&lt;2, 1, 2, 2&gt;::type zyzz, bgbb, ptpp;
    swizzler&lt;2, 2, 0, 0&gt;::type zzxx, bbrr, ppss;
    swizzler&lt;2, 2, 0, 1&gt;::type zzxy, bbrg, ppst;
    swizzler&lt;2, 2, 0, 2&gt;::type zzxz, bbrb, ppsp;
    swizzler&lt;2, 2, 1, 0&gt;::type zzyx, bbgr, ppts;
    swizzler&lt;2, 2, 1, 1&gt;::type zzyy, bbgg, pptt;
    swizzler&lt;2, 2, 1, 2&gt;::type zzyz, bbgb, pptp;
    swizzler&lt;2, 2, 2, 0&gt;::type zzzx, bbbr, ppps;
    swizzler&lt;2, 2, 2, 1&gt;::type zzzy, bbbg, pppt;
    swizzler&lt;2, 2, 2, 2&gt;::type zzzz, bbbb, pppp;
};</code></pre></div></div></section>
<section id="code_swizzler_code_design"><h2><code>swizzler&lt;&gt;</code> design</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;
    typename vector_type,
    typename scalar_type,
    size_t N,
    size_t... indices&gt;
struct swizzler
{
    T data[N];
    // N might differ from vector_type::num_components
    // ex: .xxxx from vec2

(etc)</code></pre></div></div></section>
<section id="code_swizzler_code_generator"><h2><code>swizzler&lt;&gt;</code> generator</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T, size_t... Ns&gt;
struct vector_base
{
    template&lt;size_t... indices&gt;
    struct swizzler_wrapper_factory
    {
        using type = swizzler&lt;
            typename vec_equiv&lt;T, sizeof...(indices)&gt;::type,
            T,
            sizeof...(Ns),
            indices...&gt;;
    };</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">    template&lt;size_t x&gt;
    struct swizzler_wrapper_factory&lt;x&gt;
    {
        using type = T; // one component vectors are just scalars
    };</code></pre></div></div></section>
<section id="code_swizzler_code_conversions" data-state="no_list_decor"><h2><code>swizzler&lt;&gt;</code> conversions</h2><div class="ulist"><ul><li class="fragment"><p>Needs to implicitly convert/assign to its <code>vector&lt;&gt;</code> equivalent</p></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">operator vector_type()
{
    vector_type vec;
    assign_across(vec, 0, indices...);
    return vec;
}</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">swizzler&amp; operator=(const vector_type&amp; vec)
{
    assign_across(vec, 0, indices...);
    return *this;
}</code></pre></div></div></li></ul></div></section>
<section id="code_swizzler_code_design_cont"><h2><code>swizzler&lt;&gt;</code> design (cont.)</h2><div class="paragraph"><p>We use same fold expression trick</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename... Indices&gt;
void assign_across(vector_type&amp; vec, size_t i, Indices ...j) const
{
    ((vec[i++] = data[j]), ...);
}</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename... Indices&gt;
void assign_across(const vector_type&amp; vec, size_t i, Indices ...j)
{
    ((data[j] = vec[i++]), ...);
}</code></pre></div></div></section>
<section id="code_swizzler_code_problem"><h2><code>swizzler&lt;&gt;</code> problem</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">vec3 v = vec4(other.xy, other.zw);</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="asm language-asm">&gt; error: no matching function for call to [...]
&gt; template argument deduction/substitution failed: [...]</code></pre></div></div>
<div class="ulist"><ul><li class="fragment"><p>Solution? Introduce another abstraction layer!</p></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape>(construct_at_index(i, decay(std::forward&lt;Args&gt;(args))), ...);</code></pre></div></div></li><li class="fragment"><p><code>decay</code> calls equivalent member function (or does nothing for scalar)</p></li><li class="fragment"><p>both <code>vector</code> and <code>swizzler</code> have one so they can interchange easily</p></li></ul></div></section>
<section id="operators_and_functions" data-state="no_list_decor"><h2>Operators and Functions</h2><div class="paragraph"><p>We will need to re-create a lot of generic utility functions</p></div>
<div class="ulist"><ul><li class="fragment"><p>
Example: the dot (inner) product of two vectors</p></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T, size_t... Ns&gt;
T dot(const vector&lt;T, Ns...&gt; &amp;, const vector&lt;T, Ns...&gt; &amp;);</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">float n = dot(vec3(1, 0, 0), vec3(0, 0, 1));</code></pre></div></div></li></ul></div></section>
<section id="functions_problem" data-state="no_list_decor"><div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">We immediately hit a big problem!</td></tr></table></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">vec3 v = vec3(1, 0, 0);
float n = dot(v.xzx, v.zyx);</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="asm language-asm">&gt; 'dot': no matching overloaded function found
&gt; could not deduce template argument</code></pre></div></div></section>
<section><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Type deduction does not consider implicit conversions!</td></tr></table></div>
<div class="ulist"><div class="title">Possible fixes</div><ul><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">float n = dot&lt;float, 0, 1, 2&gt;(v.xzx, v.zyx);</code></pre></div></div></li><li class="fragment"><p>create by hand all scalar/size combinations :(</p></li><li class="fragment"><p>duplicate functions for swizzler proxy as well :|</p></li><li class="fragment"><p>SFINAE tricks</p></li></ul></div></section>
<section id="a_better_fix" data-state="no_list_decor"><h2>A better fix</h2><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">we place the functions in a non-deduced context: inside <code>vector&lt;&gt;</code> itself!</td></tr></table></div>
<div class="ulist"><ul><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename T, size_t... Ns&gt;
struct vector
{
    ...
    friend T dot(const vector&amp; a, const vector&amp; b)
    {
        /* inline friend found via ADL */
    }
    ...</code></pre></div></div></li></ul></div></section>
<section id="enough"><h2>Enough?</h2><div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">No!</td></tr></table></div>
<div class="ulist"><ul><li class="fragment"><p></p><div class="listingblock"><div class="title">lots of function need to work with scalars only</div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">float opS(float d1, float d2)
{
    return max(-d2, d1);
}</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="title">ambiguity with literals</div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">smoothstep(0, 1, v.xyz);

// could be `int`, `float` or `double`</code></pre></div></div></li></ul></div></section>
<section id="solution" data-state="no_list_decor"><h2>Solution</h2><div class="paragraph"><p>Inspect the list of function args and deduct a vector type using <code>std::common_type</code> techniques</p></div>
<div class="ulist"><ul><li class="fragment"><p></p><div class="listingblock"><div class="title">first: need to make <code>vec1</code> convert to/from scalars</div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">std::is_convertible&lt;vec1, float&gt;::value == true</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="title">then: write the custom traits</div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">promote_to_vec&lt; float                &gt;::type == vec1</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">promote_to_vec&lt; vec3                 &gt;::type == vec3
promote_to_vec&lt; decltype(vec3().xyz) &gt;::type == vec3</code></pre></div></div></li><li class="fragment"><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">promote_to_vec&lt; vec3, float          &gt;::type == vec3
promote_to_vec&lt; vec3, float, double  &gt;::type == vec3</code></pre></div></div></li></ul></div></section>
<section id="solution_cont"><h2>Solution (cont.)</h2><div class="listingblock"><div class="title">Insted of <code>inline</code> functions are <code>static</code></div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;template&lt;class, size_t...&gt; class vector, class T, size_t...
struct builtin_func_lib
{
    static T dot(const vector&amp; a, const vector&amp; b)
(etc)</code></pre></div></div>
<div class="listingblock"><div class="title">Create an all-forwarding monster function</div><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;class... Args&gt;
inline auto func(Args&amp;&amp;... args) -&gt;
    decltype(decay(
        promote_to_vec&lt;Args...&gt;::type::
        func(std::forward&lt;Args&gt;(args)...)))
{
    return
        promote_to_vec&lt;Args...&gt;::type::
        func(std::forward&lt;Args&gt;(args)...);
}</code></pre></div></div></section>
<section id="the_code_matrix_code_datatype"><h2>the <code>matrix&lt;&gt;</code> datatype</h2><div class="paragraph"><p>Now that we have <code>vector&lt;&gt;</code> a matrix is more straightforward</p></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">two dimensional &#8594; introduce helper type for the indices</td></tr></table></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;size_t...&gt;
struct indices_pack;</code></pre></div></div></section>
<section id="the_code_matrix_code_datatype_cont"><h2>the <code>matrix&lt;&gt;</code> datatype (cont.)</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;
    typename scalar_type,
    template&lt;typename, size_t...&gt; class vector_type,
    size_t... Columns,
    size_t... Rows
&gt;
struct matrix&lt;scalar_type, vector_type,
    indices_pack&lt;Columns...&gt;, indices_pack&lt;Rows...&gt;&gt;</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">{
    static constexpr auto N = sizeof...(Columns);
    static constexpr auto M = sizeof...(Rows);

    using column_type = vector_type&lt;scalar_type, Columns...&gt;;
    using row_type = vector_type&lt;scalar_type, Rows...&gt;;

    column_type data[M];
(etc)</code></pre></div></div></section>
<section id="the_code_matrix_code_constructors"><h2>the <code>matrix&lt;&gt;</code> constructors</h2><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">matrix() = default; // zeroes all data</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">explicit matrix(scalar_type s) // fill in diagonally
{
    ((data[Rows][Rows] = s), ...);
}</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">template&lt;typename... Args&gt;
explicit matrix(Args&amp;&amp;... args)
{
    size_t i = 0;
    (construct_at_index(i,
        detail::decay(std::forward&lt;Args&gt;(args))), ...);
}</code></pre></div></div></section>
<section id="the_code_matrix_code_ops_and_funcs"><h2>the <code>matrix&lt;&gt;</code> ops and funcs</h2><div class="ulist"><ul><li><p>can recycle the same binary operators as vector if written generic</p></li><li><p>except <em>multiplication</em></p><div class="ulist"><ul><li><p>which needs to be handled differently</p></li><li><p>for all variations of <code>matrix</code>, <code>row_type</code>, <code>column_type</code></p></li></ul></div></li></ul></div></section>
<section id="prior_art"><h2>Prior Art</h2><div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">not invented here :)</td></tr></table></div>
<div class="ulist"><ul><li class="fragment"><p>clang vector extensions</p><div class="ulist"><ul><li><p></p><div class="listingblock"><div class="content"><pre class="highlight"><code data-noescape class="cpp language-cpp">typedef float vec3 __attribute__((ext_vector_type(3)));</code></pre></div></div></li><li><p>very limited in initializations, but support full swizzling</p></li></ul></div></li><li class="fragment"><p>various libraries</p><div class="ulist"><ul><li><p>GLM - <code>.xyz()</code> style only</p></li><li><p>CXXSwizzle - full spec but slow debug</p></li></ul></div></li></ul></div></section>
<section id="results"><h2>Results</h2></section>
<section><div class="paragraph"><p>&#8230;&#8203;but first: Crash Course into Procedural Graphics!</p></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Courtesy of @ReinderNijhoff <a href="https://www.shadertoy.com/view/4dSfRc" class="bare">https://www.shadertoy.com/view/4dSfRc</a></td></tr></table></div></section>
<section id="raymarch_tutorial_step_1" data-background-image="img/tutorial/step_1.png"></section>
<section id="raymarch_tutorial_step_2" data-background-image="img/tutorial/step_2.png"></section>
<section id="raymarch_tutorial_step_3" data-background-image="img/tutorial/step_3.png"></section>
<section id="raymarch_tutorial_step_4" data-background-image="img/tutorial/step_4.png"></section>
<section id="raymarch_tutorial_step_5" data-background-image="img/tutorial/step_5.png"></section>
<section id="raymarch_tutorial_step_6" data-background-video="vid/raymarch.mp4" data-background-video-loop data-background-video-muted></section>
<section id="raymarch_tutorial_step_7" data-background-image="img/tutorial/step_7.png"></section>
<section id="raymarch_tutorial_step_8" data-background-image="img/tutorial/step_8.png"></section>
<section id="showcase"><h2>Showcase</h2></section>
<section id="gpu_desktop_pc"><h2>GPU / desktop PC</h2><div class="ulist"><ul><li><p><a href="https://www.shadertoy.com/user/valentingalea" class="bare">https://www.shadertoy.com/user/valentingalea</a></p></li><li><p>Nvidia GeForce 1060</p></li><li><p>1080p</p></li></ul></div></section>
<section id="cpu_desktop_pc"><h2>CPU / desktop PC</h2><div class="ulist"><ul><li><p>minimal draw app with <a href="https://www.libsdl.org/" class="bare">https://www.libsdl.org/</a></p></li><li><p>AMD FX 8350 8-core 4.00 GHz</p></li><li><p>Microsoft Visual C++ 15.7.6</p><div class="ulist"><ul><li><p><code>/O2 /Ob2 /fp:fast /fp:except- /arch:SSE2 /openmp</code></p></li></ul></div></li><li><p>320 x 240 px</p></li></ul></div></section>
<section id="cpu_mobile_phone"><h2>CPU / mobile phone</h2><div class="ulist"><ul><li><p>C4Droid app (<a href="https://play.google.com/store/apps/details?id=com.n0n3m4.droidc" class="bare">https://play.google.com/store/apps/details?id=com.n0n3m4.droidc</a>)</p></li><li><p>Samsung Galaxy S7</p></li><li><p>GCC 7.2.0</p><div class="ulist"><ul><li><p><code>-Ofast -march=native -funroll-loops</code></p></li></ul></div></li><li><p>100 x 100 px</p></li></ul></div></section>
<section id="planet_gpu" data-background-video="vid/planet.mp4" data-background-video-loop data-background-video-muted></section>
<section id="planet_cpu"><h2>Planet (CPU)</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><span class="image"><img src="img/showcase/pc_planet.png" alt="Planet(PC)"></span></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><span class="image"><img src="img/showcase/droid_planet.jpg" alt="Planet(Droid)" width="300" height="300"></span></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Desktop PC</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Mobile Phone</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">.1 FPS :(</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">5 FPS</p></td></tr></table></section>
<section id="clouds_gpu" data-background-video="vid/clouds.mp4" data-background-video-loop data-background-video-muted></section>
<section id="clouds_cpu"><h2>Clouds (CPU)</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><span class="image"><img src="img/showcase/pc_clouds.png" alt="Clouds(PC)"></span></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><span class="image"><img src="img/showcase/droid_clouds.jpg" alt="Clouds(Droid)" width="300" height="300"></span></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Desktop PC</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Mobile Phone</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1 FPS</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">8 FPS</p></td></tr></table></section>
<section id="vinyl_turntable_gpu" data-background-video="vid/vinyl.mp4" data-background-video-loop data-background-video-muted></section>
<section id="vinyl_turntable_cpu"><h2>Vinyl Turntable (CPU)</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><span class="image"><img src="img/showcase/pc_vinyl.png" alt="Vinyl(PC)"></span></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><span class="image"><img src="img/showcase/droid_vinyl.jpg" alt="Clouds(Droid)" width="300" height="300"></span></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Desktop PC</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Mobile Phone</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1 FPS</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">12 FPS</p></td></tr></table></section>
<section id="the_end" data-background-video="vid/egg.mp4" data-background-video-loop data-background-video-muted><div class="ulist"><ul><li class="fragment"><p><span class="image"><img src="img/icon/twitter.png" alt="Twitter" width="64" height="64"></span> @valentin_galea</p></li><li class="fragment"><p><span class="image"><img src="img/icon/github.png" alt="Github" width="64" height="64"></span> <a href="https://github.com/valentingalea/" class="bare">https://github.com/valentingalea/</a></p></li><li class="fragment"><p><span class="image"><img src="img/sd-brand/SD-logo-white-orange.svg" alt="SD" width="128" height="128"></span> <a href="https://www.splashdamage.com/" class="bare">https://www.splashdamage.com/</a></p></li></ul></div></section>
<section id="attribution"><h2>Attribution</h2><div class="ulist"><ul><li><p>Piotr Gwiazdowski @gwiazdorrr for original inspiration and help</p></li><li><p>Shading and Renderman: Jaume Sanchez | @thespite</p></li><li><p>Motivation Shaders: Inigo Quilez <a href="https://www.shadertoy.com/view/ld3Gz2" class="bare">https://www.shadertoy.com/view/ld3Gz2</a> <a href="https://www.shadertoy.com/view/ldScDh" class="bare">https://www.shadertoy.com/view/ldScDh</a> <a href="https://www.shadertoy.com/view/4ttSWf" class="bare">https://www.shadertoy.com/view/4ttSWf</a></p></li><li><p>GPU pipeline: <a href="https://open.gl/" class="bare">https://open.gl/</a> (CC BY-SA 4.0)</p></li><li><p>All other images under "Fair Use"/"Fair Dealing"</p></li></ul></div></section></div></div><script src="node_modules/reveal.js/lib/js/head.min.js"></script><script src="node_modules/reveal.js/js/reveal.js"></script><script>// See https://github.com/hakimel/reveal.js#configuration for a full list of configuration options
Reveal.initialize({
  // Display controls in the bottom right corner
  controls: true,
  // Display a presentation progress bar
  progress: true,
  // Set a per-slide timing for speaker notes, null means none
  defaultTiming: null,
  // Display the page number of the current slide
  slideNumber: true,
  // Push each slide change to the browser history
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  previewLinks: false,
  // Theme (e.g., beige, black, league, night, serif, simple, sky, solarized, white)
  // NOTE setting the theme in the config no longer works in reveal.js 3.x
  //theme: Reveal.getQueryHash().theme || 'black',
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: Reveal.getQueryHash().transition || 'fade',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 960,
  height: 700,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // Optional libraries used to extend on reveal.js
//
// plugins config
//
// https://github.com/denehyg/reveal.js-menu
menu: {
    // Specifies which side of the presentation the menu will 
    // be shown. Use 'left' or 'right'.
    side: 'left',

    // Specifies the width of the menu.
    // Can be one of the following:
    // 'normal', 'wide', 'third', 'half', 'full', or
    // any valid css length value
    width: 'normal',

    // Add slide numbers to the titles in the slide list.
    // Use 'true' or format string (same as reveal.js slide numbers)
    numbers: true,

    // If slides do not have a matching title, attempt to use the
    // start of the text content as the title instead
    useTextContentForMissingTitles: true,

    // Hide slides from the menu that do not have a title.
    // Set to 'true' to only list slides with titles.
    hideMissingTitles: false,

    // Adds markers to the slide titles to indicate the 
    // progress through the presentation. Set to 'false'
    // to hide the markers.
    markers: true,

    // Specify custom panels to be included in the menu, by
    // providing an array of objects with 'title', 'icon'
    // properties, and either a 'src' or 'content' property.
    custom: false,

    // Specifies the themes that will be available in the themes
    // menu panel. Set to 'true' to show the themes menu panel
    // with the default themes list. Alternatively, provide an
    // array to specify the themes to make available in the
    // themes menu panel, for example...
    // [
    //     { name: 'Black', theme: 'css/theme/black.css' },
    //     { name: 'White', theme: 'css/theme/white.css' },
    //     { name: 'League', theme: 'css/theme/league.css' }
    // ]
    themes: true,

    // Specifies the path to the default theme files. If your
    // presentation uses a different path to the standard reveal
    // layout then you need to provide this option, but only
    // when 'themes' is set to 'true'. If you provide your own 
    // list of themes or 'themes' is set to 'false' the 
    // 'themesPath' option is ignored.
    themesPath: 'css/theme/',

    // Specifies if the transitions menu panel will be shown.
    // Set to 'true' to show the transitions menu panel with
    // the default transitions list. Alternatively, provide an
    // array to specify the transitions to make available in
    // the transitions panel, for example...
    // ['None', 'Fade', 'Slide']
    transitions: true,

    // Adds a menu button to the slides to open the menu panel.
    // Set to 'false' to hide the button.
    openButton: true,

    // If 'true' allows the slide number in the presentation to
    // open the menu panel. The reveal.js slideNumber option must 
    // be displayed for this to take effect
    openSlideNumber: false,

    // If true allows the user to open and navigate the menu using
    // the keyboard. Standard keyboard interaction with reveal
    // will be disabled while the menu is open.
    keyboard: true,

    // Normally the menu will close on user actions such as
    // selecting a menu item, or clicking the presentation area.
    // If 'true', the sticky option will leave the menu open
    // until it is explicitly closed, that is, using the close
    // button or pressing the ESC or m key (when the keyboard 
    // interaction option is enabled).
    sticky: false,

    // If 'true' standard menu items will be automatically opened
    // when navigating using the keyboard. Note: this only takes 
    // effect when both the 'keyboard' and 'sticky' options are enabled.
    autoOpen: true,

    // If 'true' the menu will not be created until it is explicitly
    // requested by calling RevealMenu.init(). Note this will delay
    // the creation of all menu panels, including custom panels, and
    // the menu button.
    delayInit: false,

    // If 'true' the menu will be shown when the menu is initialised.
    openOnInit: false,

    // By default the menu will load it's own font-awesome library
    // icons. If your presentation needs to load a different
    // font-awesome library the 'loadIcons' option can be set to false
    // and the menu will not attempt to load the font-awesome library.
    loadIcons: true
},
// https://github.com/tkrkt/reveal.js-elapsed-time-bar
allottedTime: 45 * 60 * 1000, // minutes
progressBarHeight: 5,
barColor: 'rgb(66, 175, 250)',

//
// plugins
//
dependencies: [
    { src: 'node_modules/reveal.js/plugin/elapsed-time-bar/elapsed-time-bar.js'}, // https://github.com/tkrkt/reveal.js-elapsed-time-bar
    { src: 'node_modules/reveal.js-menu/menu.js' } // https://github.com/denehyg/reveal.js-menu

    , // default plugins past this point; also add new-line
      { src: 'node_modules/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'node_modules/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'node_modules/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'node_modules/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'node_modules/reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: 'node_modules/reveal.js/plugin/notes/notes.js', async: true }
  ]
});</script></body></html>